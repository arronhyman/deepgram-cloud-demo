<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepgram Solutions Engineer Demo</title>
    <style>
        body { background: #111; color: #fff; font-family: sans-serif; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .container { text-align: center; max-width: 600px; }
        button { padding: 15px 30px; font-size: 18px; cursor: pointer; background: #fb3640; color: white; border: none; border-radius: 5px; font-weight: bold; }
        button.active { background: #444; }
        #transcript { margin-top: 20px; font-size: 24px; color: #aaa; min-height: 50px; }
        #ai-response { margin-top: 20px; font-size: 24px; color: #00ffcc; font-weight: bold; }
        .status { font-size: 12px; color: #555; margin-top: 50px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Deepgram <span style="color:#fb3640">Live Agent</span></h1>
        <button id="micBtn">Start Demo</button>
        <div id="transcript">Listening...</div>
        <div id="ai-response"></div>
        <div class="status">Connected to: deepgram.lesuto.com</div>
    </div>

    <script>
        // REPLACE THIS URL AFTER YOUR FIRST DEPLOY (See Step 6)
        const API_URL = "YOUR_LAMBDA_FUNCTION_URL_HERE"; 

        let socket;
        let mediaRecorder;

        document.getElementById('micBtn').addEventListener('click', async () => {
            const btn = document.getElementById('micBtn');
            if (btn.innerText === "Stop") {
                window.location.reload(); // Quick reset
                return;
            }

            // 1. Get Auth Token
            btn.innerText = "Connecting...";
            const authRes = await fetch(API_URL + "?route=auth", { method: 'POST' });
            const { key } = await authRes.json();

            // 2. Open Microphone
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });

            // 3. Connect to Deepgram WebSocket
            socket = new WebSocket(`wss://api.deepgram.com/v1/listen?model=nova-2&smart_format=true`, [
                'token', key
            ]);

            socket.onopen = () => {
                btn.innerText = "Stop";
                btn.classList.add("active");
                
                mediaRecorder.addEventListener('dataavailable', event => {
                    if (event.data.size > 0 && socket.readyState === 1) {
                        socket.send(event.data);
                    }
                });
                mediaRecorder.start(250); // Send chunk every 250ms
            };

            socket.onmessage = async (message) => {
                const received = JSON.parse(message.data);
                const transcript = received.channel.alternatives[0].transcript;
                if (transcript && received.is_final) {
                    document.getElementById('transcript').innerText = `You: ${transcript}`;
                    
                    // 4. Send to Brain
                    const brainRes = await fetch(API_URL, {
                        method: 'POST',
                        body: JSON.stringify({ text: transcript })
                    });
                    const brainData = await brainRes.json();
                    document.getElementById('ai-response').innerText = `AI: ${brainData.response}`;
                    
                    // Optional: Add TTS playback here using Deepgram Speak API
                }
            };
        });
    </script>
</body>
</html>